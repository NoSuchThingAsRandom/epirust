# Make sure you set DOCKER_HOST_IP environment variable

version: '3.7'

services:
  engine:
    container_name: epi-engine
    image: epi-engine:latest
    build:
      context: ../engine
    depends_on:
      - kafka
    environment:
      RUST_LOG: INFO
      EPI_KAFKA_URL: "localhost:29092"
    command: cargo run --release -- --daemon

  server:
    image: epi-web:latest
    container_name: epi-server
    build:
     context: ../web
    environment:
      DATABASE_URL: "mongodb://127.0.0.1:27018/local_database"
      KAFKA_URL: "localhost:29092"
    working_dir: /web/server    
    command: npm start
    ports:
      - "3000:3000"

  kafka-consumer:
    image: epi-web:latest
    container_name: epi-kafka-consumers
    environment:
      DATABASE_URL: "mongodb://127.0.0.1:27018/local_database"
      KAFKA_URL: "localhost:29092"
    build:
      context: ../web
    working_dir: /web/server  
    command: npm run start-consumers  

  react-spa:
    image: epi-web:latest
    container_name: epi-react-spa
    build:
     context: ../web
    working_dir: /web/react-spa 
    command: sh -c "npm rebuild node-sass && npm start"
    depends_on:
      - server
    ports:
      - "3001:3001"

