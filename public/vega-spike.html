<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="An app that lets you visualize epidemiology data sets" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega@5.9.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@4.5.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.3.2"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">  
    <style>
        .form-row {
            margin: 20px;
            width: 50%;
        }
        
        input {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <form onsubmit="handleSubmitData(event)">
        <div class="form-row">
            <div class="col">
                
                <label for="number_of_agents">Number of Agents</label>
                <input type="number" name="number_of_agents" class="form-control" id="number_of_agents"
                aria-describedby="number_of_agents" placeholder="Number of Agents" value="10000" />
                
                <label for="disease_name">Disease Name</label>
                <input type="text" name="disease_name" class="form-control" id="disease_name"
                aria-describedby="disease_name" placeholder="Disease Name" value="small_pox" />
                
                <label for="grid_size">Grid Size</label>
                <input type="number" name="grid_size" class="form-control" id="grid_size"
                aria-describedby="grid_size" placeholder="Grid Size" value="250" />
                
                <label for="simulation_hrs">Simulation Hours</label>
                <input type="number" name="simulation_hrs" class="form-control" id="simulation_hrs"
                aria-describedby="simulation_hrs" placeholder="Simulation Hours" value="10000" />
                
                <label for="public_transport_percentage">Public Transport Percentage</label>
                <input type="number" name="public_transport_percentage" class="form-control" id="public_transport_percentage"
                aria-describedby="public_transport_percentage" placeholder="Public Transport Percentage" value="0.2" />
                
                <label for="working_percentage">Working Percentage</label>
                <input type="number" name="working_percentage" class="form-control" id="working_percentage"
                aria-describedby="working_percentage" placeholder="Working Percentage" value="0.7" />
                
                <label for="vaccinate_at">Vaccinate At</label>
                <input type="number" name="vaccinate_at" class="form-control" id="vaccinate_at"
                aria-describedby="vaccinate_at" placeholder="Vaccinate At" value="5000" />
                
                <label for="vaccinate_percentage">Vaccinate Percentage</label>
                <input type="number" name="vaccinate_percentage" class="form-control" id="vaccinate_percentage"
                aria-describedby="vaccinate_percentage" placeholder="Vaccinate Percentage" value="0.2" />
            </div>
            <div class="col">
                <button type="submit" class="btn btn-primary">Submit</button>
                <button type="button" class="btn btn-danger" onclick="handleStopSimulation(event)">Stop</button>
                <button type="button" class="btn btn-primary" id="startBtn" disabled onclick="handleStartSimulation(event)">Start</button>
            </div>
        </div>
    </form>

    <div id="vis"></div>
    
    <script>
        
        const spec = {
            $schema: 'https://vega.github.io/schema/vega-lite/v4.json',
            data: { name: 'table' },
            autosize: {
                "resize": true
            },
            width: window.innerWidth - 200,
            height: window.innerHeight - 200,
            encoding: { "x": { "field": "hour", "type": "quantitative" } },
            layer: [
            {
                encoding: {
                    color: { field: 'category', type: 'nominal' },
                    y: { field: 'agents', type: 'quantitative' }
                },
                layer: [
                { "mark": "line" },
                { "transform": [{ "filter": { "selection": "hover" } }], "mark": "point" }
                ]
            },
            {
                "transform": [{ "pivot": "category", "value": "agents", "groupby": ["hour"] }],
                "mark": "rule",
                "encoding": {
                    "opacity": {
                        "condition": { "value": 0.3, "selection": "hover" },
                        "value": 0
                    },
                    "tooltip": [
                    { "field": "susceptible", "type": "quantitative" },
                    { "field": "infected", "type": "quantitative" },
                    { "field": "quarantined", "type": "quantitative" },
                    { "field": "recovered", "type": "quantitative" },
                    { "field": "deceased", "type": "quantitative" }
                    ]
                },
                "selection": {
                    "hover": {
                        "type": "single",
                        "fields": ["hour"],
                        "nearest": true,
                        "on": "mouseover",
                        "empty": "none",
                        "clear": "mouseout"
                    }
                }
            }
            ]
        };
        
        let socket = null;
        let renderResult = null;
        
        vegaEmbed('#vis', spec, { defaultStyle: true })
        .then(function (result) {
            const view = result.view;
            renderResult = view;
        })
        .catch(console.warn);

        function handleSubmitData(e) {
            e.preventDefault();
            let paramsData = {}
            new FormData(e.target).forEach(function (value, key) {
                if(["number_of_agents", 
                "grid_size", 
                "simulation_hrs", 
                "public_transport_percentage", 
                "working_percentage", 
                "vaccinate_at", 
                "vaccinate_percentage"].includes(key)){
                    value = Number(value);
                }
                paramsData[key] = value;
            });
            
            fetch("http://localhost:3000/simulation/init", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(paramsData)
            })
            .then(()=> {
                document.getElementById("startBtn").disabled = false;
            });
        }

        function handleStopSimulation(e) {
            e.preventDefault();
            socket.close();
        }
        
        function handleStartSimulation(e){
            e.preventDefault();
            fetch("http://localhost:3000/simulation", {
                method: 'POST',
                headers: {
                    'Content-Type':'application/json'
                }
            })
            .then((res) => {
                socket = io('http://localhost:3000/');
            })
            startSocket()
        }
        
        function startSocket() {
            // connect to simple echo server
            const socket = io('http://localhost:3000/')
            
            let dataBuffer = [];
            
            socket.on('epidemicStats', function (messageRaw) {
                const message = JSON.parse(messageRaw);
                console.log(message.hour);
                
                let susceptibleData = {
                    hour: message.hour,
                    agents: message.susceptible,
                    category: 'susceptible'
                }
                let infectedData = {
                    hour: message.hour,
                    agents: message.infected,
                    category: 'infected'
                }
                let quarantinedData = {
                    hour: message.hour,
                    agents: message.quarantined,
                    category: 'quarantined'
                }
                let recoveredData = {
                    hour: message.hour,
                    agents: message.recovered,
                    category: 'recovered'
                }
                let deceasedData = {
                    hour: message.hour,
                    agents: message.deceased,
                    category: 'deceased'
                }
                
                dataBuffer = [...dataBuffer, susceptibleData, infectedData, quarantinedData, recoveredData, deceasedData]
                // Use the Vega view api to insert data
                
                if (message.hour % 100 === 0) {
                    let changeSet = vega.changeset().insert(dataBuffer);
                    renderResult.change('table', changeSet).run();
                    dataBuffer = [];
                }
                
            });
            
        }

    </script>
</body>